/**
 * @description       : Calendar App Controller with Cost Detail integration and Dynamic Picklist
 * @author            : sejin.park@dkbmc.com
 * @last modified on  : 2025-07-18
 * @last modified by  : sejin.park@dkbmc.com
**/
public with sharing class CalendarAppController {
    public class EventWrapper {
        @AuraEnabled public My_Event__c event;
        @AuraEnabled public List<Cost_Detail__c> costs;
        @AuraEnabled public String accountName;
    }

    // --- ë°ì´í„° ì¡°íšŒ(Read)ëŠ” Selector í´ë˜ìŠ¤ì— ìœ„ì„ ---

    @AuraEnabled(cacheable=true)
    public static List<My_Event__c> getEvents(String startStr, String endStr) {
        return CalendarEventSelector.selectEventsByDateRange(
            (Datetime)JSON.deserialize('"' + startStr + '"', Datetime.class),
            (Datetime)JSON.deserialize('"' + endStr + '"', Datetime.class)
        );
    }

    // ğŸ”¥ ìºì‹œ ì œê±°: ì´ë²¤íŠ¸ ìƒì„¸ ì •ë³´ëŠ” ì‹¤ì‹œê°„ìœ¼ë¡œ ê°€ì ¸ì™€ì•¼ í•¨
    @AuraEnabled
    public static EventWrapper getEventDetails(Id eventId) {
        EventWrapper wrapper = new EventWrapper();
        wrapper.event = CalendarEventSelector.selectEventDetailsById(eventId);
        wrapper.costs = wrapper.event.Cost_Details1__r;

        if (wrapper.event != null && wrapper.event.Related_Record_Type__c == 'Account') {
            List<Account> accs = [SELECT Name FROM Account WHERE Id = :wrapper.event.Related_Record_Id__c LIMIT 1];
            if (!accs.isEmpty()) {
                wrapper.accountName = accs[0].Name;
            }
        }
        return wrapper;
    }

    @AuraEnabled(cacheable=true)
    public static Map<String, Decimal> getMonthlyCostSummary(String startDate, String endDate) {
        return CalendarEventSelector.selectMonthlyCostSummary(
            (Datetime)JSON.deserialize('"' + startDate + '"', Datetime.class),
            (Datetime)JSON.deserialize('"' + endDate + '"', Datetime.class)
        );
    }

    @AuraEnabled(cacheable=true)
    public static List<Account> getAccountList() {
        return CalendarEventSelector.selectAccounts();
    }

    @AuraEnabled(cacheable=true)
    public static List<Contact> getContactList() {
        return CalendarEventSelector.selectContacts();
    }

    @AuraEnabled(cacheable=true)
    public static List<Opportunity> getOpportunityList() {
        return CalendarEventSelector.selectOpportunities();
    }

    @AuraEnabled(cacheable=true)
    public static List<Map<String, String>> getDepartmentOptions() {
        return CalendarEventSelector.selectDepartmentOptions();
    }

    @AuraEnabled(cacheable=true)
    public static List<Map<String, String>> getCostTypeOptions() {
        return CalendarEventSelector.selectCostTypeOptions();
    }

    // ğŸ”¥ saveEventAndCosts ë©”ì„œë“œì˜ ë‚ ì§œ ì²˜ë¦¬ ë¶€ë¶„ ìˆ˜ì •
    @AuraEnabled
    public static String saveEventAndCosts(
        Id recordId, String title, String startDate, String endDate,
        String description, String location, String department,
        String relatedId, String recordType, String costDetailsJson
    ) {
        try {
            // í•„ìˆ˜ ê°’ ê²€ì¦
            if (String.isBlank(title)) {
                throw new AuraHandledException('ì œëª©ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
            }

            My_Event__c eventToSave;

            if (recordId == null) {
                eventToSave = new My_Event__c();
            } else {
                List<My_Event__c> events = [SELECT Id FROM My_Event__c WHERE Id = :recordId LIMIT 1];
                if (events.isEmpty()) {
                    throw new AuraHandledException('ìˆ˜ì •í•  ì´ë²¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                eventToSave = events[0];
            }

            eventToSave.Name = title;
            eventToSave.Title__c = title;
            eventToSave.Description__c = description;
            eventToSave.Location__c = location;
            eventToSave.Related_Record_Id__c = relatedId;
            eventToSave.Related_Record_Type__c = recordType;

            // ğŸ”¥ ë‚ ì§œ ì²˜ë¦¬ ê°œì„  - ë¡œì»¬ ì‹œê°„ ê·¸ëŒ€ë¡œ ì €ì¥
            if (String.isNotBlank(startDate)) {
                try {
                    // LWCì—ì„œ ì „ë‹¬ëœ ë¡œì»¬ ì‹œê°„ ë¬¸ìì—´ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                    String cleanStartDate = startDate;
                    if (!cleanStartDate.contains('T')) {
                        cleanStartDate += 'T00:00:00';
                    }
                    
                    // ë¡œì»¬ ì‹œê°„ìœ¼ë¡œ íŒŒì‹± (GMT ë³€í™˜ ì—†ì´)
                    DateTime parsedStartDate = DateTime.valueOf(cleanStartDate.replace('T', ' '));
                    eventToSave.Start_DateTime__c = parsedStartDate;
                    
                    System.debug('Start Date Input: ' + startDate);
                    System.debug('Parsed Start Date: ' + parsedStartDate);
                    
                } catch (Exception e) {
                    System.debug('Date parsing error: ' + e.getMessage());
                    // í´ë°±: ê¸°ì¡´ ë°©ì‹
                    eventToSave.Start_DateTime__c = Datetime.valueOfGmt(startDate.replace('T', ' ') + ':00');
                }
            }
            
            if (String.isNotBlank(endDate)) {
                try {
                    String cleanEndDate = endDate;
                    if (!cleanEndDate.contains('T')) {
                        cleanEndDate += 'T23:59:59';
                    }
                    
                    DateTime parsedEndDate = DateTime.valueOf(cleanEndDate.replace('T', ' '));
                    eventToSave.End_DateTime__c = parsedEndDate;
                    
                    System.debug('End Date Input: ' + endDate);
                    System.debug('Parsed End Date: ' + parsedEndDate);
                    
                } catch (Exception e) {
                    System.debug('Date parsing error: ' + e.getMessage());
                    // í´ë°±: ê¸°ì¡´ ë°©ì‹
                    eventToSave.End_DateTime__c = Datetime.valueOfGmt(endDate.replace('T', ' ') + ':00');
                }
            }

            upsert eventToSave;
            Id eventId = eventToSave.Id;

            // ê¸°ì¡´ ë¹„ìš© ì‚­ì œ
            List<Cost_Detail__c> oldCosts = [SELECT Id FROM Cost_Detail__c WHERE My_Event__c = :eventId];
            if (!oldCosts.isEmpty()) {
                delete oldCosts;
            }

            // ìƒˆ ë¹„ìš© ë°ì´í„° ì²˜ë¦¬
            List<Cost_Detail__c> costsToInsert = new List<Cost_Detail__c>();
            
            if (String.isNotBlank(costDetailsJson) && recordType != 'Personal') {
                try {
                    List<Object> parsedCosts = (List<Object>)JSON.deserializeUntyped(costDetailsJson);
                    
                    for (Object costObj : parsedCosts) {
                        Map<String, Object> costMap = (Map<String, Object>)costObj;
                        
                        String costType = String.valueOf(costMap.get('type'));
                        Object amountObj = costMap.get('amount');
                        
                        if (String.isBlank(costType) || amountObj == null) {
                            continue;
                        }
                        
                        Decimal amount;
                        try {
                            amount = Decimal.valueOf(String.valueOf(amountObj));
                            if (amount <= 0) {
                                continue;
                            }
                        } catch (Exception e) {
                            continue;
                        }

                        String deptValue = String.isNotBlank(department) ? department : 'ê°œë°œë¶€';
                        
                        Cost_Detail__c newCost = new Cost_Detail__c(
                            My_Event__c = eventId,
                            Cost_Type__c = costType,
                            Amount__c = amount,
                            department__c = deptValue
                        );
                        costsToInsert.add(newCost);
                    }
                } catch (Exception jsonEx) {
                    throw new AuraHandledException('ë¹„ìš© ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            }
            
            if (!costsToInsert.isEmpty()) {
                insert costsToInsert;
            }
            
            return eventId;

        } catch (Exception e) {
            String errorMessage = e.getMessage();
            if (e instanceof AuraHandledException) {
                throw e;
            } else {
                throw new AuraHandledException('ì´ë²¤íŠ¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + errorMessage);
            }
        }
    }
    
    @AuraEnabled
    public static String updateEventDates(Id eventId, String newStartDate, String newEndDate) {
        try {
            My_Event__c eventToUpdate = [SELECT Id FROM My_Event__c WHERE Id = :eventId LIMIT 1];
            
            if (String.isNotBlank(newStartDate)) {
                eventToUpdate.Start_DateTime__c = Datetime.valueOfGmt(newStartDate.replace('T', ' ') + ':00');
            }
            if (String.isNotBlank(newEndDate)) {
                eventToUpdate.End_DateTime__c = Datetime.valueOfGmt(newEndDate.replace('T', ' ') + ':00');
            }
            
            update eventToUpdate;
            
            return 'SUCCESS';
            
        } catch (Exception e) {
            throw new AuraHandledException('ì¼ì • ë‚ ì§œ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }

    @AuraEnabled
    public static String deleteEvent(Id eventId) {
        try {
            // ë¨¼ì € ê´€ë ¨ëœ ë¹„ìš© ìƒì„¸ ì‚­ì œ
            List<Cost_Detail__c> relatedCosts = [SELECT Id FROM Cost_Detail__c WHERE My_Event__c = :eventId];
            if (!relatedCosts.isEmpty()) {
                delete relatedCosts;
            }
            
            // ì´ë²¤íŠ¸ ì‚­ì œ
            My_Event__c eventToDelete = [SELECT Id FROM My_Event__c WHERE Id = :eventId LIMIT 1];
            delete eventToDelete;
            
            return 'SUCCESS';
            
        } catch (Exception e) {
            throw new AuraHandledException('ì¼ì • ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.getMessage());
        }
    }
}