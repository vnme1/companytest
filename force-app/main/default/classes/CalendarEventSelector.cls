/**
 * @description       : ë°ì´í„°ë² ì´ìŠ¤ ì¡°íšŒ(SOQL)ë¥¼ ì „ë‹´í•˜ëŠ” í´ë˜ìŠ¤.
 * @author            : sejin.park@dkbmc.com
 */
public with sharing class CalendarEventSelector {

    // ğŸ”¥ ìƒ‰ìƒ êµ¬ë¶„ì„ ìœ„í•´ Related_Record_Type__c í•„ë“œ ì¶”ê°€
    public static List<My_Event__c> selectEventsByDateRange(Datetime startDt, Datetime endDt) {
        return [
            SELECT Id, Title__c, Start_DateTime__c, End_DateTime__c, Related_Record_Type__c
            FROM My_Event__c
            WHERE Start_DateTime__c <= :endDt AND End_DateTime__c >= :startDt
            AND OwnerId = :UserInfo.getUserId()
            ORDER BY Start_DateTime__c LIMIT 200
        ];
    }

    // ì´ë²¤íŠ¸ ìƒì„¸ ì •ë³´ì™€ ê´€ë ¨ ë¹„ìš© ë™ì‹œ ì¡°íšŒ - Child Relationship Name ìˆ˜ì •
    public static My_Event__c selectEventDetailsById(Id eventId) {
        return [
            SELECT 
                Id, Name, Title__c, Start_DateTime__c, End_DateTime__c, Description__c, Location__c, 
                Related_Record_Id__c, Related_Record_Type__c,
                (SELECT Id, Cost_Type__c, Amount__c, department__c FROM Cost_Details1__r)
            FROM My_Event__c
            WHERE Id = :eventId
            LIMIT 1
        ];
    }

    // ì›”ë³„ ë¹„ìš© í•©ê³„ ì¡°íšŒ - ìˆ˜ì •ëœ ë²„ì „
    public static Map<String, Decimal> selectMonthlyCostSummary(Datetime startDateTime, Datetime endDateTime) {
        Map<String, Decimal> summary = new Map<String, Decimal>();

        // ëª¨ë“  ë¹„ìš© íƒ€ì…ì— ëŒ€í•´ 0ìœ¼ë¡œ ì´ˆê¸°í™”
        Schema.DescribeFieldResult fieldResult = Cost_Detail__c.Cost_Type__c.getDescribe();
        for (Schema.PicklistEntry entry : fieldResult.getPicklistValues()) {
            if (entry.isActive()) {
                summary.put(entry.getValue(), 0);
            }
        }

        // ì‹¤ì œ ë¹„ìš© í•©ê³„ ê³„ì‚°
        List<AggregateResult> results = [
            SELECT Cost_Type__c, SUM(Amount__c) totalAmount
            FROM Cost_Detail__c
            WHERE My_Event__r.Start_DateTime__c >= :startDateTime 
            AND My_Event__r.Start_DateTime__c <= :endDateTime
            AND My_Event__r.OwnerId = :UserInfo.getUserId()
            GROUP BY Cost_Type__c
        ];

        for (AggregateResult ar : results) {
            String costType = (String)ar.get('Cost_Type__c');
            Decimal amount = (Decimal)ar.get('totalAmount');
            if (costType != null && amount != null) {
                summary.put(costType, amount);
            }
        }
        
        return summary;
    }

    // Account, Contact, Opportunity ëª©ë¡ ì¡°íšŒ
    public static List<Account> selectAccounts() {
        return [SELECT Id, Name, Owner.Name FROM Account ORDER BY Name LIMIT 200];
    }
    
    public static List<Contact> selectContacts() {
        return [SELECT Id, Name, Account.Name, Owner.Name FROM Contact WHERE AccountId != NULL ORDER BY Name LIMIT 200];
    }
    
    public static List<Opportunity> selectOpportunities() {
        return [SELECT Id, Name, StageName, CloseDate, Owner.Name, Account.Name FROM Opportunity ORDER BY CloseDate DESC LIMIT 200];
    }

    // Picklist ì˜µì…˜ ì¡°íšŒ
    private static List<Map<String, String>> getPicklistOptions(SObjectField field) {
        List<Map<String, String>> options = new List<Map<String, String>>();
        Schema.DescribeFieldResult fieldResult = field.getDescribe();
        for (Schema.PicklistEntry entry : fieldResult.getPicklistValues()) {
            if (entry.isActive()) {
                options.add(new Map<String, String>{'label' => entry.getLabel(), 'value' => entry.getValue()});
            }
        }
        return options;
    }

    public static List<Map<String, String>> selectDepartmentOptions() {
        return getPicklistOptions(Cost_Detail__c.department__c);
    }

    public static List<Map<String, String>> selectCostTypeOptions() {
        return getPicklistOptions(Cost_Detail__c.Cost_Type__c);
    }
}